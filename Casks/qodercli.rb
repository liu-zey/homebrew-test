# This file was generated by GoReleaser. DO NOT EDIT.
cask "qodercli" do
  # Create installation source marker after installation for update detection
  postflight do
    require 'fileutils'
    require 'time'

    # Core installation steps (must succeed, same as original version)
    marker = staged_path/'.qodercli-install-resource'
    File.write(marker, "homebrew-cask")
    marker.chmod(0644)

    (staged_path/"qodercli").chmod(0755)

    bin_binary = HOMEBREW_PREFIX/"bin"/"qodercli"
    ENV['QODER_CLI_INSTALL'] = '1'

    # Logging and verification (failures here won't block installation)
    begin
      # Setup logging directory
      log_dir = File.expand_path("~/.qoder/logs")
      FileUtils.mkdir_p(log_dir)

      timestamp = Time.now.strftime("%Y%m%d_%H%M%S")
      log_file = File.join(log_dir, "qodercli_install_homebrew_#{timestamp}.log")

      # Create and write to log file
      log = File.open(log_file, 'w')
      log.puts "Installation started at #{Time.now.iso8601}"
      log.puts "Installation method: homebrew"
      log.puts "Platform: #{RUBY_PLATFORM}"
      log.puts "Homebrew prefix: #{HOMEBREW_PREFIX}"
      log.puts "================================\n"

      log.flush

      # Create symlink to latest log
      latest_log = File.join(log_dir, "qodercli_install.log")
      File.unlink(latest_log) if File.exist?(latest_log) || File.symlink?(latest_log)
      File.symlink(log_file, latest_log)

      # Verify installation and get version
      version_output = `#{bin_binary} --version 2>&1`.strip

      if $?.success?
        log.puts "Installation verified successfully"
        log.puts "Version: #{version_output}"
        puts "\nðŸŽ‰ #{version_output} installed successfully!"
      else
        log.puts "[ERROR] Version check failed: #{version_output}"
        puts "\nâš ï¸  Installation completed but version check failed"
      end

      log.puts "\nInstallation completed at #{Time.now.iso8601}"
      log.close

      puts "Get started: qodercli --help"
      puts "Installation log: #{log_file}\n"

    rescue => e
      # Logging failed, but installation succeeded
      puts "\nðŸŽ‰ Qoder CLI installed successfully!"
      puts "Get started: qodercli --help"
      puts "(Note: Installation log could not be created: #{e.message})\n"
    end
  end

  name "qodercli"
  desc "Qoder AI CLI tool - Terminal-based AI assistant for code development"
  homepage "https://qoder.com"
  version "0.1.26-qoderwork"

  livecheck do
    skip "Auto-generated on release."
  end

  binary "qodercli"

  on_macos do
    on_intel do
      url "https://qs-cli-dev.oss-cn-hangzhou.aliyuncs.com/qoderwork/releases/#{version}/qodercli_#{version}_darwin_amd64.zip"
      sha256 "aacaac0a8edf07bd46f9eb697e5e7a3dbae1aff76f64c80ef359074e947e1e08"
    end
    on_arm do
      url "https://qs-cli-dev.oss-cn-hangzhou.aliyuncs.com/qoderwork/releases/#{version}/qodercli_#{version}_darwin_arm64.zip"
      sha256 "bf04b1c67ee088e2ae8d832c8737212c4b997acbc01b1fab0f03908f1e7e5235"
    end
  end

  on_linux do
    on_intel do
      url "https://qs-cli-dev.oss-cn-hangzhou.aliyuncs.com/qoderwork/releases/#{version}/qodercli_#{version}_linux_amd64.tar.gz"
      sha256 "96ebb2b0b0fff772646f15a472e97fed4f0e841f45b4232d793564d99c1027e6"
    end
    on_arm do
      url "https://qs-cli-dev.oss-cn-hangzhou.aliyuncs.com/qoderwork/releases/#{version}/qodercli_#{version}_linux_arm64.tar.gz"
      sha256 "e72b0c46b1f7527d3f28702d57c6595d7e913f763ea924da166e6f82f0d2fe55"
    end
  end

  # No zap stanza required
end
